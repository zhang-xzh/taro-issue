import util from"./../utils/util";import{EVENT}from"./../components/trtc-room/common/constants";Page({data:{rtcConfig:{sdkAppID:"",userID:"",userSig:"",template:"",isReady:!1,isHide:!1},roomTimeout:null,show_auth_panel:!1,authInfo:""},getAuth:function(e){console.log("getAuth");const o=this;wx.authorize({scope:"scope.camera",success(){},fail:function(){console.log("您未允许使用摄像头权限")},complete:function(){o.data.isReady?o.isAuthOk(e):wx.authorize({scope:"scope.record",success(){},fail:function(){console.log("您未允许使用录音权限")},complete:function(){console.log("开始判断是否有权限"),o.isAuthOk(e)}})}})},isAuthOk:function(e){var o=this;wx.getSetting({success(t){console.log("获取授权信息成功");var n=t.authSetting["scope.record"],s=t.authSetting["scope.camera"];if(console.log("isRecordAuthOk",n),n&&s)o.setData({show_auth_panel:!1,authInfo:"摄像头、录音功能都已授权"}),o.authOkToDo(e),console.log("摄像头、录音功能都已授权");else{var i="";s||(i="摄像头 "),n||(i+="录音功能"),i+="还未授权",console.log(i),o.setData({show_auth_panel:!0,authInfo:i})}},fail:function(e){console.log("获取收取信息失败",e)}})},authOkToDo(e){this.handleStart(e)},checkNetWork:function(e){var o=this;wx.getNetworkType({success:function(t){"none"!==t.networkType?e():(console.log("Network is none"),o.showErrorToast({ErrorCode:101,ErrorMsg:"网络异常，请稍后重试"}))},fail:function(){console.log("Get Network exception"),o.showErrorToast({ErrorCode:101,ErrorMsg:"网络异常，请稍后重试"})}})},showErrorToast:function(e){this.setData({showErrorMsg:!0,err:e})},setErrorcode:function(){const e={url:`${wx.IVBaseUrl}/api/conf`,method:"GET"};util.requestPromise(e).then(e=>{this.setData({isLock:!1}),200!==e.statusCode?console.log("get Errorcode fail, use local Errorcode"):0!==e.data.code?console.log("get Errorcode fail, use local Errorcode"):(console.log("get Errorcode success, use remote Errorcode"),wx.IVResultCode=e.data.data)}).catch(e=>{console.log("get Errorcode fail, use local Errorcode"),console.log(e)})},getParams:function(e){const o=wx.IVdefaultConfig.Common.LivenessMode;return new Promise((t,n)=>{const s={url:`${wx.IVBaseUrl}/api/enterRoom?bizToken=${e}&livenessMode=${o}`,method:"GET"};util.requestPromise(s).then(o=>{this.setData({isLock:!1}),200!==o.statusCode?(wx.showModal({title:"提示",content:"网络异常,请稍后重试",showCancel:!1,complete:()=>{wx.reLaunch({url:`/faceid-interactive-video-mpsdk/index/index?curPage=3&code=199&BizToken=${e}`})}}),n(new Error)):0!==o.data.code?(wx.showModal({title:"提示",content:`${o.data.message}（${o.data.code}，${e}）`,showCancel:!1,complete:()=>{wx.reLaunch({url:`/faceid-interactive-video-mpsdk/index/index?curPage=3&code=3&BizToken=${e}`})}}),n(new Error)):t(o.data.data)}).catch(o=>{console.log(o),wx.showModal({title:"提示",content:"网络异常,请稍后重试",showCancel:!1,complete:()=>{wx.reLaunch({url:`/faceid-interactive-video-mpsdk/index/index?curPage=3&code=199&BizToken=${e}`})}})})})},enterRoom:function(e){e.template=e.template||"1v1",e.roomID=e.roomID||this.randomRoomID(),e.userID=e.userID||this.randomUserID(),console.log("* room enterRoom",e),this.template=e.template,this.data.rtcConfig={sdkAppID:e.sdkAppID,userID:e.userID,userSig:e.userSig,template:"1v1",debugMode:e.debugMode,beautyLevel:9,enableIM:!0},this.setData({rtcConfig:this.data.rtcConfig},()=>{const o=this;this.trtcComponent.enterRoom(e).then(()=>{console.log("* room timeout start"),clearTimeout(),o.data.roomTimeout=setTimeout(()=>{o.trtcComponent.exitRoom(),wx.reLaunch({url:`/faceid-interactive-video-mpsdk/index/index?curPage=3&code=201&BizToken=${e.BizToken}`}),console.log("* long time no response")},18e4),o.setData({isReady:!0})}).catch(e=>{console.error("* room joinRoom 进房失败:",e)})})},bindTRTCRoomEvent:function(e){const o=this.trtcComponent.EVENT;this.timestamp=[],this.trtcComponent.on(o.LOCAL_JOIN,e=>{console.log("* room LOCAL_JOIN",e),!0!==this.options.localVideo&&"1v1"!==this.options.template||this.trtcComponent.publishLocalVideo(),!0!==this.options.localAudio&&"1v1"!==this.options.template||this.trtcComponent.publishLocalAudio()}),this.trtcComponent.on(o.LOCAL_LEAVE,e=>{this.trtcComponent.exitRoom(),this.data.roomTimeout&&clearTimeout(this.data.roomTimeout),wx.reLaunch({url:`/faceid-interactive-video-mpsdk/index/index?curPage=3&code=100&BizToken=${this.options.BizToken}`}),console.log("* room LOCAL_LEAVE",e)}),this.trtcComponent.on(o.ERROR,e=>{console.log("* room ERROR",e)}),this.trtcComponent.on(o.REMOTE_USER_JOIN,e=>{console.log("* room REMOTE_USER_JOIN",e,this.trtcComponent.getRemoteUserList()),this.timestamp.push(new Date)}),this.trtcComponent.on(o.REMOTE_USER_LEAVE,e=>{console.log("* room REMOTE_USER_LEAVE",e,this.trtcComponent.getRemoteUserList()),this.timestamp=[],this.remoteUser=null,this.data.roomTimeout&&clearTimeout(this.data.roomTimeout);const o=this.options.BizToken,t={url:`${wx.IVBaseUrl}/api/result?bizToken=${o}`,method:"GET"};util.requestPromise(t).then(e=>{if(this.trtcComponent.exitRoom(),200!==e.statusCode)wx.showModal({title:"提示",content:"网络异常",showCancel:!1});else if(0!==e.data.code)wx.reLaunch({url:`/faceid-interactive-video-mpsdk/index/index?curPage=3&code=-1&BizToken=${o}`});else{const t=+e.data.data.Result;0===t?wx.reLaunch({url:`/faceid-interactive-video-mpsdk/index/index?curPage=2&code=${t}&BizToken=${o}`}):wx.reLaunch({url:`/faceid-interactive-video-mpsdk/index/index?curPage=3&code=${t}&BizToken=${o}`})}})}),this.trtcComponent.on(o.REMOTE_VIDEO_ADD,e=>{console.log("* room REMOTE_VIDEO_ADD",e,this.trtcComponent.getRemoteUserList());const o=this.trtcComponent.getRemoteUserList(),t=e.data;if("1v1"!==this.template||this.remoteUser&&this.remoteUser!==t.userID?"grid"===this.template&&this.trtcComponent.subscribeRemoteVideo({userID:t.userID,streamType:t.streamType}):(this.remoteUser=t.userID,this.trtcComponent.subscribeRemoteVideo({userID:t.userID,streamType:t.streamType})),"custom"===this.template&&t.userID&&t.streamType){let e=o.findIndex(e=>e.userID===t.userID);const n=320*++e+160;this.trtcComponent.setViewRect({userID:t.userID,streamType:t.streamType,xAxis:"480rpx",yAxis:n+"rpx",width:"240rpx",height:"320rpx"})}}),this.trtcComponent.on(o.REMOTE_VIDEO_REMOVE,e=>{console.log("* room REMOTE_VIDEO_REMOVE",e,this.trtcComponent.getRemoteUserList())}),this.trtcComponent.on(o.REMOTE_AUDIO_ADD,e=>{console.log("* room REMOTE_AUDIO_ADD",e,this.trtcComponent.getRemoteUserList());const o=e.data;"1v1"!==this.template||this.remoteUser&&this.remoteUser!==o.userID?"grid"!==this.template&&"custom"!==this.template||this.trtcComponent.subscribeRemoteAudio({userID:o.userID}):(this.remoteUser=o.userID,this.trtcComponent.subscribeRemoteAudio({userID:o.userID}))}),this.trtcComponent.on(o.REMOTE_AUDIO_REMOVE,e=>{console.log("* room REMOTE_AUDIO_REMOVE",e,this.trtcComponent.getRemoteUserList())}),this.trtcComponent.on(o.IM_SDK_READY,e=>{console.log("* room IM_SDK_READY",e)}),this.trtcComponent.on(o.IM_MESSAGE_RECEIVED,e=>{console.log("* room IM_MESSAGE_RECEIVED",e.data)}),this.trtcComponent.on(o.REMOTE_STATE_UPDATE,e=>{try{const o=e.data.detail.code;-2301===o?wx.showModal({title:"提示",content:"您的网络连接已断开",showCancel:!1,complete:function(){wx.reLaunch({url:`/faceid-interactive-video-mpsdk/index/index?curPage=3&code=199&BizToken=${this.options.BizToken}`})}}):2103===o||[2104,2105,2107].includes(o)||[3002,3003,3005].includes(o)}catch(e){}console.log("* room REMOTE_STATE_UPDATE",e)})},randomUserID:function(){return(new Date).getTime().toString(16).split("").reverse().join("")},randomRoomID:function(){return parseInt(9999*Math.random())},handleStart:function(e){console.log("options",e),setTimeout(()=>{this.setErrorcode(),this.getParams(e.BizToken).then(o=>{const t=o.roomId,n=o.sig,s=o.userId,i=o.sdkAppid;this.trtcComponent=this.selectComponent("#trtc-component"),this.bindTRTCRoomEvent(e.BizToken),Object.getOwnPropertyNames(e).forEach(o=>{"true"===e[o]&&(e[o]=!0),"false"===e[o]&&(e[o]=!1)}),this.options=e,this.enterRoom({BizToken:e.BizToken,sdkAppID:i,userSig:n,roomID:Number(t),userID:s,template:e.tefrontCamera,localVideo:e.lmplate,debugMode:e.debugMode,cloudenv:e.cloudenv,frontCamera:e.ocalVideo,localAudio:e.localAudio,enableEarMonitor:e.enableEarMonitor,enableAutoFocus:e.enableAutoFocus,localMirror:e.localMirror,enableAgc:e.enableAgc,enableAns:e.enableAns,encsmall:e.encsmall,videoHeight:e.videoHeight,videoWidth:e.videoWidth,scene:e.scene,maxBitrate:Number(e.maxBitrate),minBitrate:Number(e.minBitrate)})}).catch(e=>{console.log(e)}),wx.setKeepScreenOn({keepScreenOn:!0})},500)},onLoad:function(e){console.log("options",e);let o=this;console.log("roomonload"),this.setData({isHide:!1,cmsConfig:wx.IVdefaultConfig,options:e}),"true"===e.disableAuthPage?this.checkNetWork(function(){o.getAuth(e)}):this.handleStart(e)},onReady:function(){wx.setKeepScreenOn({keepScreenOn:!0})},onShow:function(){wx.setKeepScreenOn({keepScreenOn:!0}),this.data.show_auth_panel&&setTimeout(()=>{this.isAuthOk(this.data.options)},500),this.data.isHide&&(this.setData({isHide:!1}),this.trtcComponent=this.selectComponent("#trtc-component"),this.trtcComponent._emitter.emit(EVENT.LOCAL_LEAVE,{userID:this.trtcComponent.data.pusher.userID}),this.trtcComponent.exitRoom())},onHide:function(){this.setData({isHide:!0})},onUnload:function(){console.log("room unload")},onPullDownRefresh:function(){},onReachBottom:function(){},onShareAppMessage:function(){}});