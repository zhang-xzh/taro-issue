import UserController from"controller/user-controller.js";import Pusher from"model/pusher.js";import{EVENT,DEFAULT_COMPONENT_CONFIG}from"common/constants.js";import Event from"utils/event.js";import*as ENV from"utils/environment.js";import MTA from"libs/mta_analysis.js";import TIM from"libs/tim-wx.js";const TAG_NAME="TRTC-ROOM";let touchX=0,touchY=0;Component({properties:{config:{type:Object,value:{sdkAppID:"",userID:"",userSig:"",template:"",debugMode:!1,enableIM:!0},observer:function(e,t){this._propertyObserver({name:"config",newVal:e,oldVal:t})}}},data:{pusher:null,debugPanel:!0,debug:!1,streamList:[],visibleStreamList:[],userList:[],template:"",cameraPosition:"",panelName:"",localVolume:0,remoteVolumeList:[],enableIM:!0,debugMode:!0,showIMPanel:!1,messageContent:"",messageList:[],maxMessageListLength:10,messageListScrollTop:0,appVersion:ENV.APP_VERSION,libVersion:ENV.LIB_VERSION,hasGridPageTipsShow:!1,gridPageCount:0,gridCurrentPage:1,gridPlayerPerPage:4,gridPagePlaceholderStreamList:[],tostText:"视频期间，请您脸部不要离开屏幕"},lifetimes:{created:function(){console.log(TAG_NAME,"created",ENV),MTA.App.init({appID:"500710685",eventID:"500710697",autoReport:!0,statParam:!0})},attached:function(){console.log(TAG_NAME,"attached"),this._init(),MTA.Page.stat()},ready:function(){console.log(TAG_NAME,"ready")},detached:function(){console.log(TAG_NAME,"detached"),this.exitRoom()},error:function(e){console.log(TAG_NAME,"error",e)}},pageLifetimes:{show:function(){console.log(TAG_NAME,"show status:",this.status),this.status.isPending&&(this._emitter.emit(EVENT.LOCAL_LEAVE,{userID:this.data.pusher.userID}),this.exitRoom()),this.status.isPush&&(this._emitter.emit(EVENT.LOCAL_LEAVE,{userID:this.data.pusher.userID}),this.exitRoom())},hide:function(){console.log(TAG_NAME,"hide")},resize:function(e){console.log(TAG_NAME,"resize",e)}},methods:{_init(){console.log(TAG_NAME,"_init"),this.userController=new UserController(this),this._emitter=new Event,this.EVENT=EVENT,this._initStatus(),this._bindEvent(),this._gridBindEvent(),this._keepScreenOn(),console.log(TAG_NAME,"_init success component:",this)},_initStatus(){this.status={isPush:!1,isPending:!1},this._lastTapTime=0,this._beforeLastTapTime=0,this._lastTapCoordinate={x:0,y:0},this._isFullscreen=!1},_propertyObserver(e){if(console.log(TAG_NAME,"_propertyObserver",e,this.data.config),"config"===e.name){const t=Object.assign({},DEFAULT_COMPONENT_CONFIG,e.newVal);console.log(TAG_NAME,"_propertyObserver config:",t),t.debugMode,t.enableIM&&t.sdkAppID&&this._initIM(t),t.sdkAppID&&e.oldVal.sdkAppID!==t.sdkAppID&&MTA&&MTA.Event.stat("sdkAppID",{value:t.sdkAppID}),this.setData({template:t.template,debugMode:t.debugMode||!1,debug:t.debugMode||!1}),this._setPusherConfig(t)}},enterRoom(e){return new Promise((t,s)=>{console.log(TAG_NAME,"enterRoom"),console.log(TAG_NAME,"params",e),console.log(TAG_NAME,"config",this.data.config),console.log(TAG_NAME,"pusher",this.data.pusher),e&&(Object.assign(this.data.pusher,e),Object.assign(this.data.config,e)),this._checkParam(this.data.config)?this._getPushUrl(this.data.config).then(s=>{this.data.pusher.url=s,this.setData({pusher:this.data.pusher},()=>{console.log(TAG_NAME,"enterRoom",this.data.pusher),this.data.pusher.getPusherContext().start(),this.status.isPush=!0,this._loginIM({...this.data.config,roomID:e.roomID}),setTimeout(()=>{console.log(""),wx.createLivePlayerContext("live-pusher",this).stop()},2e3),t()})}).catch(e=>{console.error(TAG_NAME,"enterRoom error",e),s(e)}):s(new Error("缺少必要参数"))})},exitRoom(){return new Promise((e,t)=>{console.log(TAG_NAME,"exitRoom"),this._exitIM(),this.data.pusher.reset(),this.status.isPush=!1;const s=this.userController.reset();this.setData({pusher:this.data.pusher,userList:s.userList,streamList:s.streamList,visibleStreamList:this._filterVisibleStream(s.streamList)},()=>{e({userList:this.data.userList,streamList:this.data.streamList}),console.log(TAG_NAME,"exitRoom success",this.data.pusher,this.data.streamList,this.data.userList)})})},publishLocalVideo(){return console.log(TAG_NAME,"publishLocalVideo 开启摄像头"),this._setPusherConfig({enableCamera:!0})},unpublishLocalVideo(){return console.log(TAG_NAME,"unpublshLocalVideo 关闭摄像头"),this._setPusherConfig({enableCamera:!1})},publishLocalAudio(){return console.log(TAG_NAME,"publishLocalAudio 开启麦克风"),this._setPusherConfig({enableMic:!0})},unpublishLocalAudio(){return console.log(TAG_NAME,"unpublshLocalAudio 关闭麦克风"),this._setPusherConfig({enableMic:!1})},subscribeRemoteVideo(e){console.log(TAG_NAME,"subscribeRemoteVideo",e);const t={muteVideo:!1},s="small"===e.streamType?"main":e.streamType,r=this.userController.getStream({userID:e.userID,streamType:s});return r.muteVideoPrev=!1,"small"!==e.streamType&&"main"!==e.streamType||r&&"main"===r.streamType&&(console.log(TAG_NAME,"subscribeRemoteVideo switch small",r.src),"small"===e.streamType?(t.src=r.src.replace("main","small"),t._definitionType="small"):"main"===e.streamType&&(r.src=r.src.replace("small","main"),t._definitionType="main"),console.log(TAG_NAME,"subscribeRemoteVideo",r.src)),this._setPlayerConfig({userID:e.userID,streamType:s,config:t})},unsubscribeRemoteVideo(e){return console.log(TAG_NAME,"unsubscribeRemoteVideo",e),this.userController.getStream({userID:e.userID,streamType:e.streamType}).muteVideoPrev=!0,this._setPlayerConfig({userID:e.userID,streamType:e.streamType,config:{muteVideo:!0}})},subscribeRemoteAudio(e){return console.log(TAG_NAME,"subscribeRemoteAudio",e),this._setPlayerConfig({userID:e.userID,streamType:"main",config:{muteAudio:!1}})},unsubscribeRemoteAudio(e){return console.log(TAG_NAME,"unsubscribeRemoteAudio",e),this._setPlayerConfig({userID:e.userID,streamType:"main",config:{muteAudio:!0}})},on(e,t,s){this._emitter.on(e,t,s)},off(e,t){this._emitter.off(e,t)},getRemoteUserList(){return this.data.userList},switchCamera(){this.data.cameraPosition||(this.data.cameraPosition=this.data.pusher.frontCamera),console.log(TAG_NAME,"switchCamera",this.data.cameraPosition),this.data.cameraPosition="front"===this.data.cameraPosition?"back":"front",this.setData({cameraPosition:this.data.cameraPosition},()=>{console.log(TAG_NAME,"switchCamera success",this.data.cameraPosition)}),this.data.pusher.getPusherContext().switchCamera()},setViewRect(e){return console.log(TAG_NAME,"setViewRect",e),"custom"!==this.data.template&&console.warn(`如需使用setViewRect方法，请初始化时设置template:"custom", 当前 template:"${this.data.template}"`),console.info("不建议谁用该方法动态修改样式，避免引起微信小程序渲染问题，建议直接修改 wxml wxss 进行样式定制化"),this.data.pusher.userID===e.userID?this._setPusherConfig({xAxis:e.xAxis,yAxis:e.yAxis,width:e.width,height:e.height}):this._setPlayerConfig({userID:e.userID,streamType:e.streamType,config:{xAxis:e.xAxis,yAxis:e.yAxis,width:e.width,height:e.height}})},setViewVisible(e){return console.log(TAG_NAME,"setViewVisible",e),"custom"!==this.data.template&&console.warn(`如需使用setViewVisible方法，请初始化时设置template:"custom", 当前 template:"${this.data.template}"`),console.info("不建议谁用该方法动态修改样式，避免引起微信小程序渲染问题，建议直接修改 wxml wxss 进行样式定制化"),this.data.pusher.userID===e.userID?this._setPusherConfig({isVisible:e.isVisible}):this._setPlayerConfig({userID:e.userID,streamType:e.streamType,config:{isVisible:e.isVisible}})},setViewZIndex(e){return console.log(TAG_NAME,"setViewZIndex",e),"custom"!==this.data.template&&console.warn(`如需使用setViewZIndex方法，请初始化时设置template:"custom", 当前 template:"${this.data.template}"`),console.info("不建议谁用该方法动态修改样式，避免引起微信小程序渲染问题，建议直接修改 wxml wxss 进行样式定制化"),this.data.pusher.userID===e.userID?this._setPusherConfig({zIndex:e.zindex||e.zIndex}):this._setPlayerConfig({userID:e.userID,streamType:e.streamType,config:{zIndex:e.zindex||e.zIndex}})},playBGM(e){return new Promise((t,s)=>{this.data.pusher.getPusherContext().playBGM({url:e.url,success:()=>{console.log(TAG_NAME,"播放背景音成功"),t()},fail:()=>{console.log(TAG_NAME,"播放背景音失败"),this._emitter.emit(EVENT.BGM_PLAY_FAIL),s(new Error("播放背景音失败"))}})})},stopBGM(){this.data.pusher.getPusherContext().stopBGM()},pauseBGM(){this.data.pusher.getPusherContext().pauseBGM()},resumeBGM(){this.data.pusher.getPusherContext().resumeBGM()},setBGMVolume(e){this.data.pusher.getPusherContext().setBGMVolume({volume:e.volume})},setMICVolume(e){this.data.pusher.getPusherContext().setMICVolume({volume:e.volume})},sendSEI(e){return new Promise((t,s)=>{this.data.pusher.getPusherContext().sendMessage({msg:e.message,success:function(e){t(e)}})})},snapshot(e){return console.log(TAG_NAME,"snapshot",e),new Promise((t,s)=>{this.captureSnapshot(e).then(e=>{wx.saveImageToPhotosAlbum({filePath:e.tempImagePath,success(s){wx.showToast({title:"已保存到相册"}),console.log("save photo is success",s),t(e)},fail:function(e){wx.showToast({icon:"none",title:"保存失败"}),console.log("save photo is fail",e),s(e)}})}).catch(e=>{s(e)})})},captureSnapshot(e){return new Promise((t,s)=>{e.userID===this.data.pusher.userID?this.data.pusher.getPusherContext().snapshot({quality:"raw",complete:e=>{console.log(TAG_NAME,"snapshot pusher",e),e.tempImagePath?t(e):(console.log("snapShot 回调失败",e),s(new Error("截图失败")))}}):this.userController.getStream(e).playerContext.snapshot({quality:"raw",complete:e=>{console.log(TAG_NAME,"snapshot player",e),e.tempImagePath?t(e):(console.log("snapShot 回调失败",e),s(new Error("截图失败")))}})})},enterFullscreen(e){return console.log(TAG_NAME,"enterFullscreen",e),new Promise((t,s)=>{this.userController.getStream(e).playerContext.requestFullScreen({direction:e.direction||0,success:e=>{console.log(TAG_NAME,"enterFullscreen success",e),t(e)},fail:e=>{console.log(TAG_NAME,"enterFullscreen fail",e),s(e)}})})},exitFullscreen(e){return console.log(TAG_NAME,"exitFullscreen",e),new Promise((t,s)=>{this.userController.getStream(e).playerContext.exitFullScreen({success:e=>{console.log(TAG_NAME,"exitFullScreen success",e),t(e)},fail:e=>{console.log(TAG_NAME,"exitFullScreen fail",e),s(e)}})})},setRemoteOrientation(e){return this._setPlayerConfig({userID:e.userID,streamType:e.streamType,config:{orientation:e.orientation}})},setViewOrientation(e){return this._setPlayerConfig({userID:e.userID,streamType:e.streamType,config:{orientation:e.orientation}})},setRemoteFillMode(e){return this._setPlayerConfig({userID:e.userID,streamType:e.streamType,config:{objectFit:e.fillMode}})},setViewFillMode(e){return this._setPlayerConfig({userID:e.userID,streamType:e.streamType,config:{objectFit:e.fillMode}})},_setPusherConfig(e){return console.log(TAG_NAME,"_setPusherConfig",e,this.data.pusher),new Promise((t,s)=>{this.data.pusher?Object.assign(this.data.pusher,e):this.data.pusher=new Pusher(e),this.setData({pusher:this.data.pusher},()=>{t(e)})})},_setPlayerConfig(e){const t=e.userID,s=e.streamType,r=e.config;return console.log(TAG_NAME,"_setPlayerConfig",e),new Promise((i,a)=>{const o=this.userController.getUser(t);o&&o.streams[s]?(Object.assign(o.streams[s],r),this.setData({streamList:this.data.streamList,visibleStreamList:this._filterVisibleStream(this.data.streamList,!0)},()=>{i(e)})):console.warn(TAG_NAME,"指定 userID 或者 streamType 不存在")})},_setList(e){console.log(TAG_NAME,"_setList",e,this.data.template);const{userList:t,streamList:s}=e;return new Promise((r,i)=>{let a=[];const o={userList:t||this.data.userList,streamList:s||this.data.streamList};"grid"===this.data.template&&(a=this._filterVisibleStream(s),o.visibleStreamList=a||this.data.visibleStreamList,o.gridPagePlaceholderStreamList=this.data.gridPagePlaceholderStreamList,o.gridCurrentPage=this.data.gridCurrentPage,o.gridPageCount=this.data.gridPageCount),this.setData(o,()=>{r(e)})})},_checkParam:e=>(console.log(TAG_NAME,"checkParam config:",e),e.sdkAppID?void 0===e.roomID?(console.error("未设置 roomID"),!1):e.roomID<1||e.roomID>4294967296?(console.error("roomID 超出取值范围 1 ~ 4294967295"),!1):e.userID?e.userSig?!!e.template||(console.error("未设置 template"),!1):(console.error("未设置 userSig"),!1):(console.error("未设置 userID"),!1):(console.error("未设置 sdkAppID"),!1)),_getPushUrl(e){return console.log(TAG_NAME,"_getPushUrl",e),ENV.IS_TRTC?new Promise((t,s)=>{e.scene=e.scene&&"rtc"!==e.scene?"live":"videocall",e.enableBlackStream=e.enableBlackStream||1,e.encsmall=e.encsmall||0,e.cloudenv=e.cloudenv||"PRO",setTimeout(()=>{const s="room://cloud.tencent.com/rtc?sdkappid="+e.sdkAppID+"&roomid="+e.roomID+"&userid="+e.userID+"&usersig="+e.userSig+"&appscene="+e.scene+"&encsmall="+e.encsmall+"&cloudenv="+e.cloudenv;console.log(TAG_NAME,"getPushUrl result:",s),t(s)},0)}):this._requestSigServer(e)},_requestSigServer(e){console.log(TAG_NAME,"_requestSigServer:",e);const t=e.sdkAppID,s=e.userID,r=e.userSig,i=e.roomID,a=e.privateMapKey;e.useCloud=void 0===e.useCloud||e.useCloud;let o=e.useCloud?"https://official.opensso.tencent-cloud.com/v4/openim/jsonvideoapp":"https://yun.tim.qq.com/v4/openim/jsonvideoapp";o+="?sdkappid="+t+"&identifier="+s+"&usersig="+r+"&random="+Date.now()+"&contenttype=json";const n={Cmd:1,SeqNo:1,BusType:7,GroupId:i},l={PrivMapEncrypt:a,TerminalType:1,FromType:3,SdkVersion:26280566};return console.log(TAG_NAME,"_requestSigServer:",o,n,l),new Promise((r,a)=>{wx.request({url:o,data:{ReqHead:n,ReqBody:l},method:"POST",success:o=>{console.log("_requestSigServer success:",o),(o.data.ErrorCode||0!==o.data.RspHead.ErrorCode)&&(console.error("获取roomsig失败"),a(o));const n=JSON.stringify(o.data.RspBody);let l="room://cloud.tencent.com?sdkappid="+t+"&roomid="+i+"&userid="+s+"&roomsig="+encodeURIComponent(n);if(e.pureAudioPushMod||e.recordId){const t={Str_uc_params:{pure_audio_push_mod:0,record_id:0}};e.pureAudioPushMod?t.Str_uc_params.pure_audio_push_mod=e.pureAudioPushMod:delete t.Str_uc_params.pure_audio_push_mod,e.recordId?t.Str_uc_params.record_id=e.recordId:delete t.Str_uc_params.record_id,l+="&bizbuf="+encodeURIComponent(JSON.stringify(t))}console.log("roomSigInfo",l),r(l)},fail:e=>{console.log(TAG_NAME,"requestSigServer fail:",e),a(e)}})})},_doubleTabToggleFullscreen(e){const t=e.timeStamp,s=this._lastTapTime,r=this._lastTapCoordinate,i=e.detail,a=Math.sqrt(Math.pow(Math.abs(i.x-r.x),2)+Math.pow(Math.abs(i.y-r.y),2));this._lastTapCoordinate=i;const o=this._beforeLastTapTime;if(console.log(TAG_NAME,"_doubleTabToggleFullscreen",e,s,o,a),t-s>0&&t-s<300&&s-o>1500&&a<20){const t=e.currentTarget.dataset.userid,r=e.currentTarget.dataset.streamtype;if(this._isFullscreen)this.exitFullscreen({userID:t,streamType:r}).then(()=>{this._isFullscreen=!1}).catch(()=>{});else{let e;this.enterFullscreen({userID:t,streamType:r,direction:e}).then(()=>{this._isFullscreen=!0}).catch(()=>{})}this._beforeLastTapTime=s}this._lastTapTime=t},_bindEvent(){this.userController.on(EVENT.REMOTE_USER_JOIN,e=>{console.log(TAG_NAME,"远端用户进房",e,e.data.userID),this.setData({userList:e.data.userList},()=>{this._emitter.emit(EVENT.REMOTE_USER_JOIN,{userID:e.data.userID})}),console.log(TAG_NAME,"REMOTE_USER_JOIN","streamList:",this.data.streamList,"userList:",this.data.userList)}),this.userController.on(EVENT.REMOTE_USER_LEAVE,e=>{console.log(TAG_NAME,"远端用户离开",e,e.data.userID),e.data.userID&&this._setList({userList:e.data.userList,streamList:e.data.streamList}).then(()=>{this._emitter.emit(EVENT.REMOTE_USER_LEAVE,{userID:e.data.userID})}),console.log(TAG_NAME,"REMOTE_USER_LEAVE","streamList:",this.data.streamList,"userList:",this.data.userList)}),this.userController.on(EVENT.REMOTE_VIDEO_ADD,e=>{console.log(TAG_NAME,"远端视频可用",e,e.data.stream.userID);const t=e.data.stream;this._setList({userList:e.data.userList,streamList:e.data.streamList}).then(()=>{t.playerContext=wx.createLivePlayerContext(t.streamID,this),this._emitter.emit(EVENT.REMOTE_VIDEO_ADD,{userID:t.userID,streamType:t.streamType})}),console.log(TAG_NAME,"REMOTE_VIDEO_ADD","streamList:",this.data.streamList,"userList:",this.data.userList)}),this.userController.on(EVENT.REMOTE_VIDEO_REMOVE,e=>{console.log(TAG_NAME,"远端视频移除",e,e.data.stream.userID);const t=e.data.stream;this._setList({userList:e.data.userList,streamList:e.data.streamList}).then(()=>{t.userID&&t.streamType&&this._emitter.emit(EVENT.REMOTE_VIDEO_REMOVE,{userID:t.userID,streamType:t.streamType})}),console.log(TAG_NAME,"REMOTE_VIDEO_REMOVE","streamList:",this.data.streamList,"userList:",this.data.userList)}),this.userController.on(EVENT.REMOTE_AUDIO_ADD,e=>{console.log(TAG_NAME,"远端音频可用",e);const t=e.data.stream;this._setList({userList:e.data.userList,streamList:e.data.streamList}).then(()=>{t.playerContext=wx.createLivePlayerContext(t.streamID,this),this._emitter.emit(EVENT.REMOTE_AUDIO_ADD,{userID:t.userID,streamType:t.streamType})}),console.log(TAG_NAME,"REMOTE_AUDIO_ADD","streamList:",this.data.streamList,"userList:",this.data.userList)}),this.userController.on(EVENT.REMOTE_AUDIO_REMOVE,e=>{console.log(TAG_NAME,"远端音频移除",e,e.data.stream.userID);const t=e.data.stream;this._setList({userList:e.data.userList,streamList:e.data.streamList}).then(()=>{t.userID&&t.streamType&&this._emitter.emit(EVENT.REMOTE_AUDIO_REMOVE,{userID:t.userID,streamType:t.streamType})}),console.log(TAG_NAME,"REMOTE_AUDIO_REMOVE","streamList:",this.data.streamList,"userList:",this.data.userList)})},_pusherStateChangeHandler(e){const t=e.detail.code,s=e.detail.message;switch(console.log(TAG_NAME,"pusherStateChange：",t,e),t){case 0:console.log(s,t);break;case 1001:console.log("已经连接推流服务器",t);break;case 1002:console.log("已经与服务器握手完毕,开始推流",t);break;case 1003:console.log("打开摄像头成功",t);break;case 1004:console.log("录屏启动成功",t);break;case 1005:console.log("推流动态调整分辨率",t);break;case 1006:console.log("推流动态调整码率",t);break;case 1007:console.log("首帧画面采集完成",t);break;case 1008:console.log("编码器启动",t);break;case 1018:console.log("进房成功",t),this._emitter.emit(EVENT.LOCAL_JOIN,{userID:this.data.pusher.userID});break;case 1019:console.log("退出房间",t);break;case 2003:console.log("渲染首帧视频",t);break;case 1020:case 1031:case 1032:case 1033:case 1034:this.userController.userEventHandler(e);break;case-1301:console.error("打开摄像头失败: ",t),this._emitter.emit(EVENT.ERROR,{code:t,message:s});break;case-1302:console.error("打开麦克风失败: ",t),this._emitter.emit(EVENT.ERROR,{code:t,message:s});break;case-1303:console.error("视频编码失败: ",t),this._emitter.emit(EVENT.ERROR,{code:t,message:s});break;case-1304:console.error("音频编码失败: ",t),this._emitter.emit(EVENT.ERROR,{code:t,message:s});break;case-1307:console.error("推流连接断开: ",t),this._emitter.emit(EVENT.ERROR,{code:t,message:s});break;case-100018:console.error("进房失败: ",t,s),this._emitter.emit(EVENT.ERROR,{code:t,message:s});break;case 5e3:console.log("小程序被挂起: ",t);break;case 1021:console.log("网络类型发生变化，需要重新进房",t);break;case 2007:console.log("本地视频播放loading: ",t);break;case 2004:console.log("本地视频播放开始: ",t);break;default:console.log(s,t)}this._emitter.emit(EVENT.LOCAL_STATE_UPDATE,e)},_pusherNetStatusHandler(e){this._emitter.emit(EVENT.LOCAL_NET_STATE_UPDATE,e)},_pusherErrorHandler(e){console.warn(TAG_NAME,"pusher error",e);try{const t=e.detail.errCode,s=e.detail.errMsg;this._emitter.emit(EVENT.ERROR,{code:t,message:s})}catch(t){console.error(TAG_NAME,"pusher error data parser exception",e,t)}},_pusherBGMStartHandler(e){},_pusherBGMProgressHandler(e){this._emitter.emit(EVENT.BGM_PLAY_PROGRESS,e)},_pusherBGMCompleteHandler(e){this._emitter.emit(EVENT.BGM_PLAY_COMPLETE,e)},_playerStateChange(e){this._emitter.emit(EVENT.REMOTE_STATE_UPDATE,e)},_playerFullscreenChange(e){this._emitter.emit(EVENT.REMOTE_FULLSCREEN_UPDATE,e),this._emitter.emit(EVENT.VIDEO_FULLSCREEN_UPDATE,e)},_bindenterpictureinpicture(e){console.log("_bindenterpictureinpicture",e)},_bindleavepictureinpicture(e){console.log("_bindleavepictureinpicture",e)},_playerNetStatus(e){const t=e.detail.info;t.netQualityLevel>=4&&this._emitter.emit(EVENT.NET_QUALITY_LOW,t.netQualityLevel),t.netJitter&&this._emitter.emit(EVENT.NET_JITTER,t.netJitter);const s=this.userController.getStream({userID:e.currentTarget.dataset.userid,streamType:e.currentTarget.dataset.streamtype});!s||s.videoWidth===t.videoWidth&&s.videoHeight===t.videoHeight||(console.log(TAG_NAME,"_playerNetStatus update video size",e),s.videoWidth=t.videoWidth,s.videoHeight=t.videoHeight),this._emitter.emit(EVENT.REMOTE_NET_STATE_UPDATE,e)},_playerAudioVolumeNotify(e){this._emitter.emit(EVENT.REMOTE_AUDIO_VOLUME_UPDATE,e)},_filterVisibleStream(e,t){const s=e.filter(e=>e.hasVideo||e.hasAudio);return s.sort((e,t)=>{const s=e.userID.toUpperCase(),r=t.userID.toUpperCase();return s<r?-1:s>r?1:0}),"grid"!==this.data.template||t||(this._filterGridPageVisibleStream(s),console.log(TAG_NAME,"_filterVisibleStream gridPagePlaceholderStreamList:",this.data.gridPagePlaceholderStreamList),this.data.gridCurrentPage>1&&this.data.gridPagePlaceholderStreamList.length===this.data.gridPlayerPerPage&&this._gridPageToPrev(s)),console.log(TAG_NAME,"_filterVisibleStream list:",s),s},_filterGridPageVisibleStream(e){const t=e.length;this.data.gridPageCount=Math.ceil((t+1)/this.data.gridPlayerPerPage),this.data.gridPagePlaceholderStreamList=[];let s,r=0;s=this.data.gridPlayerPerPage>3?1===this.data.gridCurrentPage?[-1,this.data.gridPlayerPerPage-1]:[this.data.gridCurrentPage*this.data.gridPlayerPerPage-(this.data.gridPlayerPerPage+2),this.data.gridCurrentPage*this.data.gridPlayerPerPage-1]:[this.data.gridCurrentPage*this.data.gridPlayerPerPage-(this.data.gridPlayerPerPage+1),this.data.gridCurrentPage*this.data.gridPlayerPerPage];for(let i=0;i<t;i++)i>s[0]&&i<s[1]?(e[i].isVisible=!0,e[i].muteVideo=e[i].muteVideoPrev||!1,r++):(e[i].isVisible=!1,e[i].muteVideo=!0);for(let e=0;e<this.data.gridPlayerPerPage-r;e++)this.data.gridPagePlaceholderStreamList.push({id:"holder-"+e});return e},_keepScreenOn(){setInterval(()=>{wx.setKeepScreenOn({keepScreenOn:!0})},2e4)},_initIM(e){if(!e.enableIM||!e.sdkAppID||this.tim)return;console.log(TAG_NAME,"_initIM",e);const t=TIM.create({SDKAppID:e.sdkAppID});t.setLogLevel(1),t.off(TIM.EVENT.SDK_READY,this._onIMReady),t.off(TIM.EVENT.MESSAGE_RECEIVED,this._onIMMessageReceived),t.off(TIM.EVENT.SDK_NOT_READY,this._onIMNotReady),t.off(TIM.EVENT.ERROR,this._onIMError),t.on(TIM.EVENT.SDK_READY,this._onIMReady,this),t.on(TIM.EVENT.MESSAGE_RECEIVED,this._onIMMessageReceived,this),t.on(TIM.EVENT.SDK_NOT_READY,this._onIMNotReady,this),t.on(TIM.EVENT.ERROR,this._onIMError,this),this.tim=t,wx.tim=t},_loginIM(e){if(this.tim)return console.log(TAG_NAME,"_loginIM",e),this.tim.login({userID:e.userID,userSig:e.userSig})},_logoutIM(){if(this.tim)return console.log(TAG_NAME,"_logoutIM"),this.tim.logout()},_exitIM(){!this.data.exitIMThrottle&&this.tim&&(this.data.exitIMThrottle=!0,this._logoutIM())},_onIMReady(e){console.log(TAG_NAME,"IM.SDK_READY",e),this._emitter.emit(EVENT.IM_SDK_READY,e)},_onIMMessageReceived(e){console.log(TAG_NAME,"IM.MESSAGE_RECEIVED",e,e.data[0]._elements[0]);const t=e.data[0]&&e.data[0]._elements[0]&&e.data[0]._elements[0].content.text||this.data.tostText;this.setData({tostText:t}),this._emitter.emit(EVENT.IM_MESSAGE_RECEIVED,e)},_onIMNotReady(e){console.log(TAG_NAME,"IM.SDK_NOT_READY",e),this._emitter.emit(EVENT.IM_SDK_NOT_READY,e)},_onIMError(e){console.log(TAG_NAME,"IM.ERROR",e),this._emitter.emit(EVENT.IM_ERROR,e)},_toggleVideo(){this.data.pusher.enableCamera?this.unpublishLocalVideo():this.publishLocalVideo()},_toggleAudio(){this.data.pusher.enableMic?this.unpublishLocalAudio():this.publishLocalAudio()},_debugToggleRemoteVideo(e){console.log(TAG_NAME,"_debugToggleRemoteVideo",e.currentTarget.dataset);const t=e.currentTarget.dataset.userID,s=e.currentTarget.dataset.streamType;this.data.streamList.find(e=>e.userID===t&&e.streamType===s).muteVideo?this.subscribeRemoteVideo({userID:t,streamType:s}):this.unsubscribeRemoteVideo({userID:t,streamType:s})},_debugToggleRemoteAudio(e){console.log(TAG_NAME,"_debugToggleRemoteAudio",e.currentTarget.dataset);const t=e.currentTarget.dataset.userID,s=e.currentTarget.dataset.streamType;this.data.streamList.find(e=>e.userID===t&&e.streamType===s).muteAudio?this.subscribeRemoteAudio({userID:t}):this.unsubscribeRemoteAudio({userID:t})},_debugToggleVideoDebug(){this.setData({debug:!this.data.debug})},_debugExitRoom(){this.exitRoom()},_debugEnterRoom(){this.enterRoom({roomID:this.data.config.roomID}).then(()=>{setTimeout(()=>{this.publishLocalVideo(),this.publishLocalAudio()},2e3)})},_debugGoBack(){wx.navigateBack({delta:1})},_debugTogglePanel(){this.setData({debugPanel:!this.data.debugPanel})},_toggleAudioVolumeType(){"voicecall"===this.data.pusher.audioVolumeType?this._setPusherConfig({audioVolumeType:"media"}):this._setPusherConfig({audioVolumeType:"voicecall"})},_toggleSoundMode(){if(0===this.data.userList.length)return;const e=this.userController.getStream({userID:this.data.userList[0].userID,streamType:"main"});e&&("speaker"===e.soundMode?e.soundMode="ear":e.soundMode="speaker",this._setPlayerConfig({userID:e.userID,streamType:"main",config:{soundMode:e.soundMode}}))},_hangUp(){this._emitter.emit(EVENT.LOCAL_LEAVE,{userID:this.data.pusher.userID}),this.exitRoom()},handleSubscribeAudio(){this.data.pusher.enableMic?this.unpublishLocalAudio():this.publishLocalAudio()},_handleSubscribeRemoteVideo(e){const t=e.currentTarget.dataset.userID,s=e.currentTarget.dataset.streamType;this.data.streamList.find(e=>e.userID===t&&e.streamType===s).muteVideo?this.subscribeRemoteVideo({userID:t,streamType:s}):this.unsubscribeRemoteVideo({userID:t,streamType:s})},_handleSubscribeRemoteAudio(e){const t=e.currentTarget.dataset.userID,s=e.currentTarget.dataset.streamType;this.data.streamList.find(e=>e.userID===t&&e.streamType===s).muteAudio?this.subscribeRemoteAudio({userID:t}):this.unsubscribeRemoteAudio({userID:t})},_switchMemberListPanel(){this.setData({panelName:"memberlist-panel"!==this.data.panelName?"memberlist-panel":""})},_switchSettingPanel(){this.setData({panelName:"setting-panel"!==this.data.panelName?"setting-panel":""})},_handleMaskerClick(){this.setData({panelName:""})},_setPuserProperty(e){console.log(TAG_NAME,"_setPuserProperty",e);const t=e.currentTarget.dataset.key,s=e.currentTarget.dataset.valueType;let r=e.currentTarget.dataset.value;const i={};"boolean"===s&&(r="true"===r,i[t]=!this.data.pusher[t]),"number"===s&&r.indexOf("|")>0&&(r=r.split("|"),this.data.pusher[t]===Number(r[0])?i[t]=Number(r[1]):i[t]=Number(r[0])),"string"===s&&r.indexOf("|")>0&&(r=r.split("|"),this.data.pusher[t]===r[0]?i[t]=r[1]:i[t]=r[0]),this._setPusherConfig(i)},_setPlayerProperty(e){console.log(TAG_NAME,"_setPlayerProperty",e);const t=e.currentTarget.dataset.userid,s=e.currentTarget.dataset.streamtype,r=e.currentTarget.dataset.key;let i=e.currentTarget.dataset.value;const a=this.userController.getStream({userID:t,streamType:s});if(!a)return;const o={};"true"===i?i=!0:"false"===i&&(i=!1),"boolean"==typeof i?o[r]=!a[r]:"string"==typeof i&&i.indexOf("|")>0&&(i=i.split("|"),a[r]===i[0]?o[r]=i[1]:o[r]=i[0]),console.log(TAG_NAME,"_setPlayerProperty",o),this._setPlayerConfig({userID:t,streamType:s,config:o})},_switchStreamType(e){const t=e.currentTarget.dataset.userid,s=e.currentTarget.dataset.streamtype,r=this.userController.getStream({userID:t,streamType:s});r&&"main"===r.streamType&&("small"===r._definitionType?this.subscribeRemoteVideo({userID:t,streamType:"main"}):this.subscribeRemoteVideo({userID:t,streamType:"small"}))},_handleSnapshotClick(e){wx.showToast({title:"开始截屏",icon:"none",duration:1e3});const t=e.currentTarget.dataset.userid,s=e.currentTarget.dataset.streamtype;this.snapshot({userID:t,streamType:s})},_gridBindEvent(){this.on(EVENT.REMOTE_AUDIO_VOLUME_UPDATE,e=>{const t=e.data,s=t.currentTarget.dataset.userid,r=t.currentTarget.dataset.streamtype,i=t.detail.volume,a=this.userController.getStream({userID:s,streamType:"aux"===r?"main":r});a&&(a.volume=i),this.setData({streamList:this.data.streamList,visibleStreamList:this._filterVisibleStream(this.data.streamList,!0)},()=>{})})},_handleGridTouchStart(e){touchX=e.changedTouches[0].clientX,touchY=e.changedTouches[0].clientY},_handleGridTouchEnd(e){const t=e.changedTouches[0].clientX,s=e.changedTouches[0].clientY;t-touchX>50&&Math.abs(s-touchY)<50?this._gridPagePrev():t-touchX<-50&&Math.abs(s-touchY)<50&&this._gridPageNext()},_gridPageToPrev(e){const t=this._filterGridPageVisibleStream(e);if(this.data.gridPagePlaceholderStreamList.length!==this.data.gridPlayerPerPage)return t;this.data.gridCurrentPage--,this._gridPageToPrev(e)},_gridPageNext(){this.data.gridCurrentPage++,this.data.gridCurrentPage>this.data.gridPageCount&&(this.data.gridCurrentPage=1),this._gridPageSetData()},_gridPagePrev(){this.data.gridCurrentPage--,this.data.gridCurrentPage<1&&(this.data.gridCurrentPage=this.data.gridPageCount),this._gridPageSetData()},_gridPageSetData(){this._gridShowPageTips();const e=this._filterVisibleStream(this.data.streamList);this.setData({gridCurrentPage:this.data.gridCurrentPage,gridPageCount:this.data.gridPageCount,visibleStreamList:e,streamList:this.data.streamList,gridPagePlaceholderStreamList:this.data.gridPagePlaceholderStreamList},()=>{})},_gridShowPageTips(e){this.data.gridPageCount<2||(console.log(TAG_NAME,"_gridShowPageTips",this.data),this.data.hasGridPageTipsShow&&clearTimeout(this.data.hasGridPageTipsShow),this.animate(".pages-container",[{opacity:1}],100,()=>{}),this.data.hasGridPageTipsShow=setTimeout(()=>{this.animate(".pages-container",[{opacity:1},{opacity:.3}],600,()=>{})},3e3))}}});